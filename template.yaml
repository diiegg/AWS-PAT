AWSTemplateFormatVersion: '2020-27-10'
Description: Template
Metadata:
###########################################################################################
  'AWS::CloudFormation::Interface':
    ParameterGroups:
      - Parameters:
          - SecurityGroupList
          - Subnets
        Label:
          default: Network Configuration
      - Parameters:
          - ImageId
          - KeyName
          - InstanceType
          - InstanceName
        Label:
          default: Basic Configuration
      - Parameters:
          - EBSOptimized
          - PlacementTenancy
          - BackupsEnabled
          - DetailedMonitoring
        Label:
          default: Advanced Configuration
      - Parameters:
          - CWLogRetention
          - ScalingNotificationTopic
          - TerminatedInstances
        Label:
          default: Cloudwatch Configuration
      - Parameters:
          - SSMRefreshFrequency
          - CustomSSMSteps
          - PatchingGroupTag
          - CustomSSMStepCount
          - SSMInventoryTag
        Label:
          default: SSM Configuration
      - Parameters:
          - EbsVolumeSize
          - Iops
          - EbsVolumeType
        Label:
          default: Primary EBS Volume properties
      - Parameters:
          - Ebs2VolumeSize
          - IopsVolume2
          - Ebs2VolumeType
          - EncryptEBSVolume
        Label:
          default: Secondary EBS Volume properties
      - Parameters:
          - ScalingCreateTimeOut
          - ScalingMin
          - ScalingTermination
          - EC2ScaleDownCooldown
          - HealthCheckGracePeriod
          - EC2ScaleUpAdjustment
          - EC2ScaleDownAdjustment
          - ScalingUpdateTimeOut
          - MinInstancesInService
          - HealthCheckType
          - ScalingMax
          - EC2ScaleUpCooldown
        Label:
          default: AutoScaling Configuration
      - Parameters:
          - LoadBalancerNames
          - TargetGroupARNs
        Label:
          default: Load Balancer Configuration (OPTIONAL)
      - Parameters:
          - CwLowOperator
          - CwScalingMetric
          - CwHighPeriod
          - CwLowPeriod
          - CwHighOperator
          - CwHighThreshold
          - CwLowThreshold
          - CwLowEvaluations
          - CwHighEvaluations
        Label:
          default: AutoScaling Alarm Configuration
        Label:
          default: FileSystem Parameters
      - Parameters:
          - Encryption
          - FileSystemName
          - PerformanceMode
          - ThroughputMode
          - KmsKeyId
        Label:
          default: FileSystem Mount Target Parameters
      - Parameters:
          - VpcId
          - MountTarget1Subnet
          - FileSharePort
          - OriginSecurityGroup
    ParameterLabels:
      ScalingCreateTimeOut:
        default: Create Signal Timeout
      LoadBalancerNames:
        default: CLB List
      CwLowOperator:
        default: Scale Down operator
      CwLowThreshold:
        default: Scale Down period
      SSMRefreshFrequency:
        default: SSM Association refresh rate
      CwScalingMetric:
        default: ASG Scaling metric
      EBSOptimized:
        default: Enable EBS Optimization
      ScalingMin:
        default: Minimum Instances
      CWLogRetention:
        default: Cloudwatch Log Retention
      Ebs2VolumeSize:
        default: Secondary EBS Volume Size
      SecurityGroupList:
        default: Security Groups
      CwHighPeriod:
        default: Scale Up period
      IopsVolume2:
        default: Secondary EBS Volume IOPS
      ImageId:
        default: Image ID
      CwLowPeriod:
        default: Scale Down period
      ScalingTermination:
        default: Termination Count
      KeyName:
        default: Key Pair
      PlacementTenancy:
        default: Tenancy
      BackupsEnabled:
        default: Backup Tag value
      HealthCheckGracePeriod:
        default: Health Check Period
      InstanceType:
        default: Instance Type
      Ebs2VolumeType:
        default: Secondary EBS Volume Type
      CwHighOperator:
        default: Scale Up operator
      TargetGroupARNs:
        default: Target Group ARNs
      EbsVolumeSize:
        default: Primary EBS Volume Size
      CustomSSMSteps:
        default: Custom Bootstrapping Steps
      EC2ScaleUpAdjustment:
        default: Scale Up by
      CwHighThreshold:
        default: Scale Up threshold
      ScalingNotificationTopic:
        default: Scale Notification Topic
      ScalingMax:
        default: Maximum Instances
      InstanceName:
        default: Instance Name
      PatchingGroupTag:
        default: SSM Patching Group
      EC2ScaleDownAdjustment:
        default: Scale Down by
      CustomSSMStepCount:
        default: Number of Custom Bootstrapping Steps
      ScalingUpdateTimeOut:
        default: Update Signal Timeout
      MinInstancesInService:
        default: Min Instance in Service
      SSMInventoryTag:
        default: Perform SSM Inventory?
      TerminatedInstances:
        default: Number of Terminated Instances
      HealthCheckType:
        default: Health Check Type
      CwLowEvaluations:
        default: Scale Down evaluations
      CwHighEvaluations:
        default: Scale Up evaluations
      Iops:
        default: Primary EBS volume IOPS
      DetailedMonitoring:
        default: Detailed Monitoring?
      EbsVolumeType:
        default: Primary EBS Volume Type
      EC2ScaleDownCooldown:
        default: Cooldown time after Scale Down
      EC2ScaleUpCooldown:
        default: Cooldown time after Scale Up
      EncryptEBSVolume:
        default: Encrypt Secondary EBS Volume?
      Encryption:
        default: Encryption
      FileSystemName:
        default: FileSystem Name
      PerformanceMode:
        default: Performance Mode
      ThroughputMode: 
        default: Throughput Mode
      KmsKeyId:
        default: KMS Key
      VpcId:
        default: VPC Id
      MountTarget1Subnet:
        default: Mount Target 1 Subnet
      FileSharePort:
        default: Access Port for FileShare
      OriginSecurityGroup:
        default: Origin Security Group
 ##############################################PARAMETERS#################################################################       
Parameters:
  ScalingCreateTimeOut:
    Default: 20M
    ConstraintDescription: '#H#M#S where each # is the number of hours or minutes or seconds'
    Type: String
    Description: >-
      Time to wait for the number of signals equal to ScalingMin. H/M/S
      Hours/Minutes/Seconds
  LoadBalancerNames:
    Default: ''
    Type: CommaDelimitedList
    Description: A list of Classic load balancers associated with this Auto Scaling group.
  CwLowOperator:
    Default: LessThanThreshold
    Type: String
    Description: Math operator used by CloudWatch for alarms and triggers.
    AllowedValues:
      - GreaterThanOrEqualToThreshold
      - GreaterThanThreshold
      - LessThanThreshold
      - LessThanOrEqualToThreshold
  InstanceRoleManagedPolicyArns:
    Default: ''
    Type: String
    Description: >-
      A comma delimited list of IAM policy ARNs for the InstanceRole IAM role. 
      IAM ARNs can be found within the Policies section of the AWS IAM console.
  Environment:
    Default: Development
    Type: String
    Description: >-
      Application environment for which this network is being created. e.g.
      Development/Production.
    AllowedValues:
      - Development
      - Integration
      - PreProduction
      - Production
      - QA
      - Staging
      - Test
  SSMRefreshFrequency:
    Default: rate(1 day)
    AllowedPattern: '^$|^rate\(\d{1,2} (minutes|hours?|days?)\)$|^cron\((\S+ ){5}\S+\)$'
    Type: String
    Description: >-
      A cron or rate pattern to define the SSM Association refresh schedule,
      defaulting to once per day.  See
      https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-cron.html
      for more details.  Schedule can be disabled by providing an empty string.
    ConstraintDescription: >-
      Must provide a valid rate or cron statement.  For more details, See
      https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-cron.html 
  CwScalingMetric:
    Default: CPUUtilization
    Type: String
    Description: Select the metric to be used for scaling.
    AllowedValues:
      - CPUUtilization
      - NetworkIn
      - NetworkOut
  EBSOptimized:
    Default: 'False'
    Type: String
    Description: Use EBS Optimized.
    AllowedValues:
      - 'False'
      - 'True'
  ScalingMin:
    Default: '1'
    AllowedPattern: '([0-9]+)'
    Type: String
    Description: The minimum size of the Auto Scaling group.
    ConstraintDescription: Must be a valid integer.
  CWLogRetention:
    Default: '30'
    Type: String
    ConstraintDescription: Must be a valid integer.
    Description: The number of days to retain Cloudwatch Logs for this instance.
    AllowedValues:
      - '1'
      - '3'
      - '5'
      - '7'
      - '14'
      - '30'
      - '60'
      - '90'
      - '120'
      - '150'
      - '180'
      - '365'
      - '400'
      - '545'
      - '731'
      - '1827'
      - '3653'
  Ebs2VolumeSize:
    Default: ''
    Type: String
    Description: Select Second EBS Volume Size in GB.
  CwHighPeriod:
    Default: '60'
    AllowedPattern: '([0-9]+)'
    Type: String
    Description: >-
      Time the specified statistic is applied. Must be in seconds that is also a
      multiple of 60.
    ConstraintDescription: Must be a valid integer.
  Subnets:
    Type: 'List<AWS::EC2::Subnet::Id>'
    Description: Subnets for Application
  IopsVolume2:
    Default: '0'
    Type: Number
    Description: >-
      Iops value required for use with io1 on secondary EBS volumes. This value
      should be 3 times the secondary EBS volume size
  EC2ScaleDownAdjustment:
    Default: '1'
    AllowedPattern: '([0-9]+)'
    Type: String
    Description: Number of EC2 instances to scale down by at a time.
    ConstraintDescription: Must be a valid integer.
  ImageId:
    AllowedPattern: '^ami-[0-9a-f]+$||^$'
    Default: ''
    Type: String
    Description: The image ID to be used to build the EC2 Instance.  (OPTIONAL)
  CwLowPeriod:
    Default: '300'
    AllowedPattern: '([0-9]+)'
    Type: String
    Description: >-
      Time the specified statistic is applied. Must be in seconds that is also a
      multiple of 60.
    ConstraintDescription: Must be a valid integer.
  ScalingTermination:
    Default: '1'
    AllowedPattern: '([0-9]+)'
    Type: String
    Description: The maximum number of instances that are terminated at a given time.
    ConstraintDescription: Must be a valid integer.
  KeyName:
    Type: 'AWS::EC2::KeyPair::KeyName'
    ConstraintDescription: Must be the name of an existing EC2 KeyPair.
    Description: Name of an existing EC2 KeyPair to enable SSH access to the instances.
  PlacementTenancy:
    Default: default
    Type: String
    Description: The placement tenancy for EC2 devices
    AllowedValues:
      - dedicated
      - default
      - host
  BackupsEnabled:
    Default: 'False'
    Type: String
    Description: 'Value of the ''Backup'' tag, used to assign the EBSSnapper configuration.'
  EC2ScaleDownCooldown:
    Default: '60'
    AllowedPattern: '([0-9]+)'
    Type: String
    Description: Time in seconds before any further trigger-related scaling can occur.
    ConstraintDescription: Must be a valid integer.
  InstanceType:
    Default: t2.micro
    ConstraintDescription: Must be a valid EC2 instance type. Default is t2.micro
    Type: String
    Description: Select instance type
    AllowedValues:
      - t2.nano
      - t2.micro
      - t2.small
      - t2.medium
      - t2.large
      - t2.xlarge
      - t2.2xlarge
      - m3.medium
      - m3.large
      - m3.xlarge
      - m3.2xlarge
      - m4.large
      - m4.xlarge
      - m4.2xlarge
      - m4.4xlarge
      - m4.10xlarge
      - m4.16xlarge
      - r3.large
      - r3.xlarge
      - r3.2xlarge
      - r3.4xlarge
      - r3.8xlarge
      - r4.large
      - r4.xlarge
      - r4.2xlarge
      - r4.4xlarge
      - r4.8xlarge
      - r4.16xlarge
      - x1.16xlarge
      - x1.32xlarge
      - x1e.xlarge
      - x1e.2xlarge
      - x1e.4xlarge
      - x1e.8xlarge
      - x1e.16xlarge
      - x1e.32xlarge
      - i2.xlarge
      - i2.2xlarge
      - i2.4xlarge
      - i2.8xlarge
      - i3.large
      - i3.xlarge
      - i3.2xlarge
      - i3.4xlarge
      - i3.8xlarge
      - i3.16xlarge
      - c3.large
      - c3.xlarge
      - c3.2xlarge
      - c3.4xlarge
      - c3.8xlarge
      - c4.large
      - c4.xlarge
      - c4.2xlarge
      - c4.4xlarge
      - c4.8xlarge
      - c5.large
      - c5.xlarge
      - c5.2xlarge
      - c5.4xlarge
      - c5.9xlarge
      - c5.18xlarge
      - g2.2xlarge
      - g2.8xlarge
      - g3.4xlarge
      - g3.8xlarge
      - g3.16xlarge
      - p2.xlarge
      - p2.8xlarge
      - p2.16xlarge
      - p3.2xlarge
      - p3.8xlarge
      - p3.16xlarge
      - d2.xlarge
      - d2.2xlarge
      - d2.4xlarge
      - d2.8xlarge
      - f1.2xlarge
      - f1.16xlarge
      - m5.large
      - m5.xlarge
      - m5.2xlarge
      - m5.4xlarge
      - m5.12xlarge
      - m5.24xlarge
      - h1.2xlarge
      - h1.4xlarge
      - h1.8xlarge
      - h1.16xlarge
  Ebs2VolumeType:
    Default: gp2
    Type: String
    Description: Select EBS Volume Type.
    AllowedValues:
      - io1
      - standard
      - gp2
  TargetGroupARNs:
    Default: ''
    Type: CommaDelimitedList
    Description: >-
      A list of Amazon Resource Names (ARN) of target groups to associate with
      the Auto Scaling group.
  EbsVolumeSize:
    Default: '60'
    Type: String
    Description: Select EBS Volume Size in GB.
  CustomSSMSteps:
    Default: ''
    Type: CommaDelimitedList
    Description: >-
      A comma delimited list of up to 5 SSM document names (not URIs) to insert
      into the instance bootstrapping. (OPTIONAL)
  EC2ScaleUpAdjustment:
    Default: '1'
    AllowedPattern: '([0-9]+)'
    Type: String
    Description: Number of EC2 instances to scale up by at a time.
    ConstraintDescription: Must be a valid integer.
  CwHighThreshold:
    Default: '60'
    AllowedPattern: '([0-9]+)'
    Type: String
    Description: The value against which the specified statistic is compared.
    ConstraintDescription: Must be a valid integer.
  ScalingNotificationTopic:
    Default: ''
    Type: String
    Description: SNS Topic ARN to notify if there are any scaling operations. OPTIONAL
  CwLowThreshold:
    Default: '30'
    AllowedPattern: '([0-9]+)'
    Type: String
    Description: The value against which the specified statistic is compared.
    ConstraintDescription: Must be a valid integer.
  InstanceName:
    Type: String
    ConstraintDescription: Must follow normal syntax conventions.
    Description: EC2 Server Instance Name
  EC2ScaleUpCooldown:
    Default: '60'
    AllowedPattern: '([0-9]+)'
    Type: String
    Description: Time in seconds before any further trigger-related scaling can occur.
    ConstraintDescription: Must be a valid integer.
  CustomSSMStepCount:
    Default: '0'
    Type: String
    Description: The number of SSM documents to insert into the instance bootstrapping.
    AllowedValues:
      - 0
      - 1
      - 2
      - 3
      - 4
      - 5
  PatchingGroupTag:
    Default: ''
    Type: String
    Description: Group ID to be used by System Manager for Patching (OPTIONAL)
  HealthCheckGracePeriod:
    Default: '300'
    AllowedPattern: '([0-9]+)'
    Type: String
    Description: Number of seconds grace during which no autoscaling actions will be taken.
    ConstraintDescription: Must be a valid integer.
  SecurityGroupList:
    Type: 'List<AWS::EC2::SecurityGroup::Id>'
    Description: A list of EC2 security groups to assign to this resource.
  ScalingUpdateTimeOut:
    Default: 20M
    ConstraintDescription: '#H#M#S where each # is the number of hours or minutes or seconds'
    Type: String
    Description: >-
      Post update pause before additional Auto Scale resource changes. H/M/S
      Hours/Minutes/Seconds
  MinInstancesInService:
    Default: '0'
    Type: Number
    Description: >-
      Specifies the minimum number of instances that must be in service within
      the Auto Scaling group while AWS CloudFormation updates old instances.  A
      value of 0 will ensure that at least the ASGs minimum instance count stays
      in service during all updates.
  SSMInventoryTag:
    Default: 'True'
    Type: String
    Description: Determines whether Instance is tracked via System Manager Inventory.
    AllowedValues:
      - 'False'
      - 'True'
  TerminatedInstances:
    Default: '30'
    Type: Number
    Description: >-
      Specifies the maximum number of instances that can be terminated in a six
      hour period without generating a Cloudwatch Alarm.
  HealthCheckType:
    Default: EC2
    Type: String
    Description: Define the type of healthcheck for the AutoScaling group.
    AllowedValues:
      - EC2
      - ELB
  CwLowEvaluations:
    Default: '3'
    AllowedPattern: '([0-9]+)'
    Type: String
    Description: >-
      The number of periods over which data is compared to the specified
      threshold.
    ConstraintDescription: Must be a valid integer.
  CwHighEvaluations:
    Default: '3'
    AllowedPattern: '([0-9]+)'
    Type: String
    Description: >-
      The number of periods over which data is compared to the specified
      threshold.
    ConstraintDescription: Must be a valid integer.
  Iops:
    Default: '0'
    Type: Number
    Description: >-
      Iops value required for use with io1 EBS volumes. This value should be 3
      times the EBS volume size
  DetailedMonitoring:
    Default: 'True'
    Type: String
    Description: Enable Detailed Monitoring.
    AllowedValues:
      - 'False'
      - 'True'
  EbsVolumeType:
    Default: gp2
    Type: String
    Description: Select EBS Volume Type.
    AllowedValues:
      - io1
      - standard
      - gp2
  ScalingMax:
    Default: '2'
    AllowedPattern: '([0-9]+)'
    Type: String
    Description: The maximum size of the Auto Scaling group.
    ConstraintDescription: Must be a valid integer.
  CwHighOperator:
    Default: GreaterThanThreshold
    Type: String
    Description: Math operator used by CloudWatch for alarms and triggers.
    AllowedValues:
      - GreaterThanOrEqualToThreshold
      - GreaterThanThreshold
      - LessThanThreshold
      - LessThanOrEqualToThreshold
  EncryptEBSVolume:
    Default: 'False'
    Type: String
    Description: Specifies whether to encrypt the EBS volume.
    AllowedValues:
      - 'False'
      - 'True'
  Encryption:
    Type: String
    Description: Enable Encryption for the FileSystem?  (Default - true)
    ConstraintDescription: Must be a boolean value (true / false)
    AllowedValues:
      - true
      - false
    Default: true
  FileSystemName:
    Type: String
    Description: Name for tagging the EFS FileSystem (Default - CloudFormationStackNameFileSystem)
    Default: " "
  PerformanceMode:
    Type: String
    Description: What performance mode would you like? (Default - generalPurpose)
    ConstraintDescription: generalPurpose and maxIO are the only valid options
    AllowedValues:
      - "generalPurpose"
      - "maxIO"
    Default: "generalPurpose"
  ThroughputMode:
    Type: String
    Description: What throughput mode would you like to use?  (Default - bursting)
    ConstraintDescription: The only valid options are bursting and provisioned
    AllowedValues:
      - "bursting"
      - "provisioned"
    Default: "bursting"  
  KmsKeyId:
  # Format for the KMS Key Id can be one of the following: 
  # -----------------------------------------------------
  # Key ID - A unique identifier of the key, for example, 1234abcd-12ab-34cd-56ef-1234567890ab.
  # ARN - An Amazon Resource Name (ARN) for the key, for example, arn:aws:kms:us-west-2:111122223333:key/1234abcd-12ab-34cd-56ef-1234567890ab.
  # Key alias - A previously created display name for a key. For example, alias/projectKey1.
  # Key alias ARN - An ARN for a key alias, for example, arn:aws:kms:us-west-2:444455556666:alias/projectKey1.
    Type: String
    Description: Would you like to use a non-default KMS key?  (Provide key id, ARN, or alias)
    Default: "None"
  # Mount Target Parameters
  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: Which VPC would you like to use?
  MountTarget1Subnet:
    Type: AWS::EC2::Subnet::Id
    Description: Which subnet would you like to use for your first Mount Target?
  FileSharePort: 
    Type: Number
    Description: Port to use for accessing the FileSystem via a Mount Target
    Default: 2049 # NFS Default Port Number
    MinValue: 1024
    MaxValue: 65535
  OriginSecurityGroup:
    Type: AWS::EC2::SecurityGroup::Id
    Description: Which SecurityGroup will be allowed to access Mount Targets for the FileSystem

######################################CONDITIONS###########################################################################################################
Conditions:
    # FileSystem Conditions
  hasFsTags: 
    !Not [!Equals [!Ref FileSystemName, " "]]
  isEncrypted:
    !Equals [!Ref Encryption, true]
  noKmsKeyId:
    !Equals [!Ref KmsKeyId, "None"]
  useDefaultCMK: !And
    - Condition: isEncrypted
    - Condition: noKmsKeyId
  # Mount Target Conditions
  is2ndEBSVolume:
    'Fn::Not':
      - 'Fn::Equals':
          - Ref: Ebs2VolumeSize
          - ''
  isEBSEncrypted:
    'Fn::Equals':
      - Ref: EncryptEBSVolume
      - 'True'
  IopsEnabled:
    'Fn::Equals':
      - Ref: EbsVolumeType
      - io1
  isMinInstance:
    'Fn::Not':
      - 'Fn::Equals':
          - Ref: MinInstancesInService
          - '0'
  EnableCustomSSMStep2:
    'Fn::Or':
      - 'Fn::Equals':
          - Ref: CustomSSMStepCount
          - '2'
      - Condition: EnableCustomSSMStep3
  EnableCustomSSMStep1:
    'Fn::Or':
      - 'Fn::Equals':
          - Ref: CustomSSMStepCount
          - '1'
      - Condition: EnableCustomSSMStep2
  EnableCustomSSMStep5:
    'Fn::Equals':
      - Ref: CustomSSMStepCount
      - 5
  EnableCustomSSMStep4:
    'Fn::Or':
      - 'Fn::Equals':
          - Ref: CustomSSMStepCount
          - '4'
      - Condition: EnableCustomSSMStep5
  IopsEnabled2:
    'Fn::Equals':
      - Ref: Ebs2VolumeType
      - io1
  EnableCustomSSMStep3:
    'Fn::Or':
      - 'Fn::Equals':
          - Ref: CustomSSMStepCount
          - '3'
      - Condition: EnableCustomSSMStep4
  InstanceRolePoliciesSet:
    'Fn::Not':
      - 'Fn::Equals':
          - Ref: InstanceRoleManagedPolicyArns
          - ''
  SetSSMSchedule:
    'Fn::Not':
      - 'Fn::Equals':
          - Ref: SSMRefreshFrequency
          - ''
  isELBv2:
    'Fn::Not':
      - 'Fn::Equals':
          - 'Fn::Select':
              - '0'
              - Ref: TargetGroupARNs
          - ''
  isImageId:
    'Fn::Not':
      - 'Fn::Equals':
          - Ref: ImageId
          - ''
  isELBv1:
    'Fn::Not':
      - 'Fn::Equals':
          - 'Fn::Select':
              - '0'
              - Ref: LoadBalancerNames
          - ''
  isScalingNotification:
    'Fn::Not':
      - 'Fn::Equals':
          - Ref: ScalingNotificationTopic
          - ''

#################################################################MAPPINGS###############################################################    
Mappings:
  AWSRegionArch2AMI:
    us-east-1:
      '64': ami-14c5486b
    us-west-1:
      '64': ami-25110f45
    ap-northeast-2:
      '64': ami-c10fa6af
    ap-northeast-1:
      '64': ami-92df37ed
    sa-east-1:
      '64': ami-3885d854
    ap-southeast-1:
      '64': ami-de90a5a2
    ca-central-1:
      '64': ami-338a0a57
    ap-southeast-2:
      '64': ami-423bec20
    us-west-2:
      '64': ami-e251209a
    us-east-2:
      '64': ami-922914f7
    ap-south-1:
      '64': ami-76d6f519
    eu-central-1:
      '64': ami-9a91b371
    eu-west-1:
      '64': ami-ca0135b3
    eu-west-2:
      '64': ami-a36f8dc4
    eu-west-3:
      '64': ami-969c2deb
###############################################################################RESOURCES#####3333###########################################
Resources:
  CWAgentParam:
    Type: 'AWS::SSM::Parameter'
    Properties:
      Type: String
      Description:
        'Fn::Sub': '${AWS::StackName} Cloudwatch Agent configuration'
      Value:
        'Fn::Join':
          - ''
          - - >-
              {"metrics": {"append_dimensions": {"InstanceId":
              "${aws:InstanceId}", "AutoScalingGroupName":
              "${aws:AutoScalingGroupName}"}, "aggregation_dimensions":
              [["InstanceId"], ["AutoScalingGroupName"], ["InstanceId",
              "device"]], "namespace": "System/Linux", "metrics_collected":
              {"mem": {"metrics_collection_interval": 60, "measurement":
              [{"rename": "MemoryUtilization", "name": "mem_used_percent",
              "unit": "Percent"}]}, "disk": {"ignore_file_system_types":
              ["devtmpfs", "tmpfs", "devfs", "rootfs"],
              "metrics_collection_interval": 60, "resources": ["*"],
              "measurement": ["used_percent"]}}}, "logs": {"logs_collected":
              {"files": {"collect_list": [{"file_path":
              "/var/log/cloud-init-output.log", "log_group_name": "
            - Ref: SystemLogs
            - >-
              ", "log_stream_name": "{instance_id}/cloud-init-output.log"},
              {"timestamp_format": "%b %d %H:%M:%S", "file_path":
              "/var/log/cloud-init.log", "log_group_name": "
            - Ref: SystemLogs
            - >-
              ", "log_stream_name": "{instance_id}/cloud-init.log"},
              {"timestamp_format": "%Y-%m-%d %H:%M:%S",
              "multi_line_start_pattern": "{timestamp_format}", "file_path":
              "/var/log/amazon/ssm/amazon-ssm-agent.log", "log_group_name": "
            - Ref: SystemLogs
            - >-
              ", "log_stream_name": "{instance_id}/amazon-ssm-agent.log"},
              {"timestamp_format": "%Y-%m-%d %H:%M:%S",
              "multi_line_start_pattern": "{timestamp_format}", "file_path":
              "/var/log/amazon/ssm/errors.log", "log_group_name": "
            - Ref: SystemLogs
            - >-
              ", "log_stream_name": "{instance_id}/amazon-ssm-errors.log"},
              {"timestamp_format": "%d/%b/%Y:%H:%M:%S", "file_path":
              "/var/log/httpd/access*", "log_group_name": "
            - Ref: ApplicationLogs
            - >-
              ", "log_stream_name": "{instance_id}/httpd-access"},
              {"timestamp_format": "%d/%b/%Y:%H:%M:%S", "file_path":
              "/var/log/httpd/error*", "log_group_name": "
            - Ref: ApplicationLogs
            - >-
              ", "log_stream_name": "{instance_id}/httpd-error"},
              {"timestamp_format": "%d/%b/%Y:%H:%M:%S", "file_path":
              "/var/log/apache2/access*", "log_group_name": "
            - Ref: ApplicationLogs
            - >-
              ", "log_stream_name": "{instance_id}/apache2-access"},
              {"timestamp_format": "%d/%b/%Y:%H:%M:%S", "file_path":
              "/var/log/apache2/error*", "log_group_name": "
            - Ref: ApplicationLogs
            - >-
              ", "log_stream_name": "{instance_id}/apache2-error"},
              {"timestamp_format": "%d/%b/%Y:%H:%M:%S", "file_path":
              "/var/log/nginx/access*", "log_group_name": "
            - Ref: ApplicationLogs
            - >-
              ", "log_stream_name": "{instance_id}/nginx-access"},
              {"timestamp_format": "%d/%b/%Y:%H:%M:%S", "file_path":
              "/var/log/nginx/error*", "log_group_name": "
            - Ref: ApplicationLogs
            - |
              ", "log_stream_name": "{instance_id}/nginx-error"}]}}}}
      Name:
        'Fn::Sub': '${AWS::StackName}-CWAgent'
  SSMDocument:
    Type: 'AWS::SSM::Document'
    Properties:
      Content:
        schemaVersion: '2.2'
        description: SSM Document for instance configuration.
        parameters: {}
        mainSteps:
          - action: 'aws:runDocument'
            inputs:
              documentPath: AWS-ConfigureAWSPackage
              documentParameters:
                action: Install
                name: AmazonCloudWatchAgent
              documentType: SSMDocument
            name: InstallCWAgent
            timeoutSeconds: 300
          - action: 'aws:runDocument'
            inputs:
              documentPath: AmazonCloudWatch-ManageAgent
              documentParameters:
                action: configure
                optionalConfigurationSource: ssm
                optionalConfigurationLocation:
                  Ref: CWAgentParam
                optionalRestart: 'yes'
                name: AmazonCloudWatchAgent
              documentType: SSMDocument
            name: ConfigureCWAgent
            timeoutSeconds: 300
          - 'Fn::If':
              - EnableCustomSSMStep1
              - action: 'aws:runDocument'
                inputs:
                  documentPath:
                    'Fn::Select':
                      - '0'
                      - Ref: CustomSSMSteps
                  documentType: SSMDocument
                name: CustomStep1
                timeoutSeconds: 300
              - Ref: 'AWS::NoValue'
          - 'Fn::If':
              - EnableCustomSSMStep2
              - action: 'aws:runDocument'
                inputs:
                  documentPath:
                    'Fn::Select':
                      - '1'
                      - Ref: CustomSSMSteps
                  documentType: SSMDocument
                name: CustomStep2
                timeoutSeconds: 300
              - Ref: 'AWS::NoValue'
          - 'Fn::If':
              - EnableCustomSSMStep3
              - action: 'aws:runDocument'
                inputs:
                  documentPath:
                    'Fn::Select':
                      - '2'
                      - Ref: CustomSSMSteps
                  documentType: SSMDocument
                name: CustomStep3
                timeoutSeconds: 300
              - Ref: 'AWS::NoValue'
          - 'Fn::If':
              - EnableCustomSSMStep4
              - action: 'aws:runDocument'
                inputs:
                  documentPath:
                    'Fn::Select':
                      - '3'
                      - Ref: CustomSSMSteps
                  documentType: SSMDocument
                name: CustomStep4
                timeoutSeconds: 300
              - Ref: 'AWS::NoValue'
          - 'Fn::If':
              - EnableCustomSSMStep5
              - action: 'aws:runDocument'
                inputs:
                  documentPath:
                    'Fn::Select':
                      - '4'
                      - Ref: CustomSSMSteps
                  documentType: SSMDocument
                name: CustomStep5
                timeoutSeconds: 300
              - Ref: 'AWS::NoValue'
          - action: 'aws:runShellScript'
            inputs:
              runCommand:
                - 'Fn::Sub': >-
                    /opt/aws/bin/cfn-signal -e 0 --stack ${AWS::StackName}
                    --resource AutoScaleGrp --region ${AWS::Region} || exit 0
            precondition:
              StringEquals:
                - platformType
                - Linux
            name: SignalStack
          - action: 'aws:runDocument'
            inputs:
              documentPath: AWS-UpdateSSMAgent
              documentType: SSMDocument
            name: UpdateSSMAgent
            timeoutSeconds: 300
      DocumentType: Command
  SystemLogs:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays:
        Ref: CWLogRetention
  EC2ScaleUpPolicy:
    Type: 'AWS::AutoScaling::ScalingPolicy'
    Properties:
      ScalingAdjustment:
        Ref: EC2ScaleUpAdjustment
      AutoScalingGroupName:
        Ref: AutoScaleGrp
      Cooldown:
        Ref: EC2ScaleUpCooldown
      AdjustmentType: ChangeInCapacity
  LaunchConfig:
    Type: 'AWS::AutoScaling::LaunchConfiguration'
    Properties:
      UserData:
        'Fn::Base64':
          'Fn::Join':
            - ''
            - - |
                #!/bin/bash -xe
              - |
                exec 1> >(logger -s -t $(basename $0)) 2>&1
              - |
                yum install -y aws-cfn-bootstrap
              - |
                yum update -y aws-cfn-bootstrap
              - |+
              - |
                # Ensure SSM installed on Amazon Linux
              - |
                # in cases where it is not available / removed
              - |
                ssm_running=$( ps -ef | grep [a]mazon-ssm-agent | wc -l )
              - |
                if [[ $ssm_running != "0" ]]; then
              - |2
                    echo -e "amazon-ssm-agent already running"
              - |
                else
              - |2
                    if [[ -r "/tmp/ssm_agent_install" ]]; then : ;
              - |2
                    else mkdir -p /tmp/ssm_agent_install; fi
              - |2
                    curl https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/linux_amd64/amazon-ssm-agent.rpm -o /tmp/ssm_agent_install/amazon-ssm-agent.rpm
              - |2
                    rpm -Uvh /tmp/ssm_agent_install/amazon-ssm-agent.rpm
              - |2
                    ssm_running=$( ps -ef | grep [a]mazon-ssm-agent | wc -l )
              - |2
                    # Amazon Linux 2
              - |2
                    systemctl=$( command -v systemctl | wc -l )
              - |2
                    if [[ $systemctl != "0" ]]; then
              - |2
                        systemctl enable amazon-ssm-agent
              - |2
                        if [[ $ssm_running == "0" ]]; then
              - |2
                            systemctl start amazon-ssm-agent
              - |2
                        fi
              - |2
                    else
              - |2
                        # Amazon Linux
              - |2
                        if [[ $ssm_running == "0" ]]; then
              - |2
                            start amazon-ssm-agent
              - |2
                        fi
              - |2
                    fi
              - |
                fi
              - |+
              - |
                # Helper function
              - |
                function exit_cfn_signal {
              - |2
                  exit_status=$?
              - |2
                  if [[ $exit_status != "0" && -e /opt/aws/bin/cfn-signal ]]; then
              - '    /opt/aws/bin/cfn-signal -e $exit_status --stack '
              - Ref: 'AWS::StackName'
              - ' --resource AutoScaleGrp --region '
              - Ref: 'AWS::Region'
              - |+
              - |2
                  fi
              - |2
                  exit $exit_status
              - |
                }
              - |
                trap exit_cfn_signal TERM EXIT
      InstanceMonitoring:
        Ref: DetailedMonitoring
      ImageId:
        'Fn::If':
          - isImageId
          - Ref: ImageId
          - 'Fn::FindInMap':
              - AWSRegionArch2AMI
              - Ref: 'AWS::Region'
              - '64'
      BlockDeviceMappings:
        - DeviceName: /dev/xvda
          Ebs:
            Iops:
              'Fn::If':
                - IopsEnabled
                - Ref: Iops
                - Ref: 'AWS::NoValue'
            DeleteOnTermination: 'true'
            VolumeType:
              Ref: EbsVolumeType
            VolumeSize:
              Ref: EbsVolumeSize
        - 'Fn::If':
            - is2ndEBSVolume
            - DeviceName: /dev/sdf
              Ebs:
                Encrypted:
                  'Fn::If':
                    - isEBSEncrypted
                    - 'true'
                    - Ref: 'AWS::NoValue'
                DeleteOnTermination: 'true'
                VolumeType:
                  Ref: Ebs2VolumeType
                VolumeSize:
                  Ref: Ebs2VolumeSize
                Iops:
                  'Fn::If':
                    - IopsEnabled2
                    - Ref: IopsVolume2
                    - Ref: 'AWS::NoValue'
            - Ref: 'AWS::NoValue'
      KeyName:
        Ref: KeyName
      SecurityGroups:
        Ref: SecurityGroupList
      PlacementTenancy:
        Ref: PlacementTenancy
      EbsOptimized:
        Ref: EBSOptimized
      IamInstanceProfile:
        Ref: InstanceRoleInstanceProfile
      InstanceType:
        Ref: InstanceType
  InstanceRoleInstanceProfile:
    Type: 'AWS::IAM::InstanceProfile'
    Properties:
      Path: /
      Roles:
        - Ref: InstanceRole
  InstanceRole:
    Type: 'AWS::IAM::Role'
    Properties:
      Path: /
      ManagedPolicyArns:
        'Fn::Split':
          - ','
          - 'Fn::Join':
              - ','
              - - 'arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM'
                - 'Fn::If':
                    - InstanceRolePoliciesSet
                    - Ref: InstanceRoleManagedPolicyArns
                    - Ref: 'AWS::NoValue'
      AssumeRolePolicyDocument:
        Statement:
          - Action:
              - 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
  AutoScaleGrp:
    CreationPolicy:
      ResourceSignal:
        Count:
          Ref: ScalingMin
        Timeout:
          'Fn::Sub': 'PT${ScalingCreateTimeOut}'
    Type: 'AWS::AutoScaling::AutoScalingGroup'
    UpdatePolicy:
      AutoScalingRollingUpdate:
        PauseTime:
          'Fn::Sub': 'PT${ScalingUpdateTimeOut}'
        WaitOnResourceSignals: 'true'
        SuspendProcesses:
          - ScheduledActions
          - ReplaceUnhealthy
          - AlarmNotification
          - AZRebalance
        MaxBatchSize:
          Ref: ScalingTermination
        MinInstancesInService:
          'Fn::If':
            - isMinInstance
            - Ref: MinInstancesInService
            - Ref: ScalingMin
    Properties:
      HealthCheckGracePeriod:
        Ref: HealthCheckGracePeriod
      NotificationConfigurations:
        - 'Fn::If':
            - isScalingNotification
            - NotificationTypes:
                - 'autoscaling:EC2_INSTANCE_LAUNCH'
                - 'autoscaling:EC2_INSTANCE_LAUNCH_ERROR'
                - 'autoscaling:EC2_INSTANCE_TERMINATE'
                - 'autoscaling:EC2_INSTANCE_TERMINATE_ERROR'
              TopicARN:
                Ref: ScalingNotificationTopic
            - Ref: 'AWS::NoValue'
      Tags:
        - PropagateAtLaunch: 'true'
          Value:
            Ref: BackupsEnabled
          Key: Backup
        - PropagateAtLaunch: 'true'
          Value:
            Ref: Environment
          Key: Environment
        - PropagateAtLaunch: 'true'
          Value:
            Ref: InstanceName
          Key: Name
        - PropagateAtLaunch: 'true'
          Value:
            Ref: PatchingGroupTag
          Key: Patch Group
        - PropagateAtLaunch: 'true'
          Value:
            Ref: SSMInventoryTag
          Key: SSMInventory
      LaunchConfigurationName:
        Ref: LaunchConfig
      MinSize:
        Ref: ScalingMin
      MaxSize:
        Ref: ScalingMax
      VPCZoneIdentifier:
        Ref: Subnets
      LoadBalancerNames:
        'Fn::If':
          - isELBv1
          - Ref: LoadBalancerNames
          - Ref: 'AWS::NoValue'
      MetricsCollection:
        - Granularity: 1Minute
      TargetGroupARNs:
        'Fn::If':
          - isELBv2
          - Ref: TargetGroupARNs
          - Ref: 'AWS::NoValue'
      HealthCheckType:
        Ref: HealthCheckType
  InstanceRolePolicies:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyName: InstanceRole
      PolicyDocument:
        Statement:
          - Action:
              - 'cloudformation:Describe*'
            Resource: '*'
            Effect: Allow
          - Action:
              - 'ssm:CreateAssociation'
              - 'ssm:DescribeInstanceInformation'
            Resource: '*'
            Effect: Allow
          - Action:
              - 'cloudwatch:PutMetricData'
              - 'cloudwatch:GetMetricStatistics'
              - 'cloudwatch:ListMetrics'
              - 'logs:CreateLogStream'
              - 'ec2:DescribeTags'
              - 'logs:DescribeLogStreams'
              - 'logs:CreateLogGroup'
              - 'logs:PutLogEvents'
              - 'ssm:GetParameter'
            Resource: '*'
            Effect: Allow
          - Action:
              - 'ec2:DescribeTags'
            Resource: '*'
            Effect: Allow
      Roles:
        - Ref: InstanceRole
  ScaleAlarmHigh:
    Type: 'AWS::CloudWatch::Alarm'
    Properties:
      EvaluationPeriods:
        Ref: CwHighEvaluations
      Dimensions:
        - Name: AutoScalingGroupName
          Value:
            Ref: AutoScaleGrp
      AlarmActions:
        - Ref: EC2ScaleUpPolicy
      AlarmDescription:
        'Fn::Sub': >-
          Scale-up if ${CwScalingMetric} ${CwHighOperator} ${CwHighThreshold}%
          for ${CwHighPeriod} seconds ${CwHighEvaluations} times.
      Namespace: AWS/EC2
      Period:
        Ref: CwHighPeriod
      ComparisonOperator:
        Ref: CwHighOperator
      Statistic: Average
      Threshold:
        Ref: CwHighThreshold
      MetricName:
        Ref: CwScalingMetric
  EC2ScaleDownPolicy:
    Type: 'AWS::AutoScaling::ScalingPolicy'
    Properties:
      ScalingAdjustment:
        'Fn::Sub': '-${EC2ScaleDownAdjustment}'
      AutoScalingGroupName:
        Ref: AutoScaleGrp
      Cooldown:
        Ref: EC2ScaleDownCooldown
      AdjustmentType: ChangeInCapacity
  SSMAssociation:
    Type: 'AWS::SSM::Association'
    Properties:
      ScheduleExpression:
        'Fn::If':
          - SetSSMSchedule
          - Ref: SSMRefreshFrequency
          - Ref: 'AWS::NoValue'
      Targets:
        - Values:
            - Ref: 'AWS::StackId'
          Key: 'tag:aws:cloudformation:stack-id'
      Name:
        Ref: SSMDocument
  ScaleAlarmLow:
    Type: 'AWS::CloudWatch::Alarm'
    Properties:
      EvaluationPeriods:
        Ref: CwLowEvaluations
      Dimensions:
        - Name: AutoScalingGroupName
          Value:
            Ref: AutoScaleGrp
      AlarmActions:
        - Ref: EC2ScaleDownPolicy
      AlarmDescription:
        'Fn::Sub': >-
          Scale-down if ${CwScalingMetric} ${CwLowOperator} ${CwLowThreshold}%
          for ${CwLowPeriod} seconds ${CwLowEvaluations} times.
      Namespace: AWS/EC2
      Period:
        Ref: CwLowPeriod
      ComparisonOperator:
        Ref: CwLowOperator
      Statistic: Average
      Threshold:
        Ref: CwLowThreshold
      MetricName:
        Ref: CwScalingMetric
  ApplicationLogs:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays:
        Ref: CWLogRetention
  FileSystem:
    Type: AWS::EFS::FileSystem
    Properties:
      Encrypted: !Ref Encryption
      FileSystemTags:
        - Key: Name
          Value: !If [hasFsTags, !Ref FileSystemName, !Sub "${AWS::StackName}FileSystem"]
      KmsKeyId: !If [useDefaultCMK, !Ref "AWS::NoValue", !Ref KmsKeyId]
      PerformanceMode: !Ref PerformanceMode
      ThroughputMode: !Ref ThroughputMode
  MountTarget1:
    Type: AWS::EFS::MountTarget
    Properties: 
      FileSystemId: !Ref FileSystem
      SubnetId: !Ref MountTarget1Subnet
      SecurityGroups: 
        - !Ref MountTargetSecurityGroup
  MountTargetSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: FileSystem Security Group
      VpcId: !Ref VpcId
      GroupName: !If [hasFsTags, !Join ["", [!Ref FileSystemName, "SecurityGroup"]], !Join ["", [!Ref "AWS::StackName", "FileSystemSecurityGroup"]]]
      SecurityGroupIngress:
        - IpProtocol: "tcp"
          FromPort: !Ref FileSharePort
          ToPort: !Ref FileSharePort
          SourceSecurityGroupId: !Ref OriginSecurityGroup
 ###############################################################OUTPUTS########################################################################         
Outputs:
  GroupName:
    Description: Autoscale Group Name
    Value:
      Ref: AutoScaleGrp
      
  FileSystemId:
    Description: The FileSystem ID number
    Value: !Ref FileSystem
    Export:
      Name: !Sub '${AWS::StackName}FileSystemId'

  MountTargetSecurityGroup:
    Description: The Group ID for the FileSystem Mount Targets Security Group
    Value: !GetAtt MountTargetSecurityGroup.GroupId
    Export:
      Name: MountTargetSecurityGroupId
    
  MountTarget1:
    Description: The Resource ID for the first FileSystem Mount Target
    Value: !Ref MountTarget1
    Export:
      Name: !Sub 
        - '${AWS::StackName}${FileSystemName}MountTarget1'
        - { FileSystemName: !If [hasFsTags, !Ref FileSystemName, "FileSystem"] }

      

